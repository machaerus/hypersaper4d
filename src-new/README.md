New version, rewritten completely in JavaScript.
